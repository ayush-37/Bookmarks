<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= user.name %>'s Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .book-card {
        display: flex;
        gap: 1rem;
        width: 100%;
        max-width: 600px;
        margin-bottom: 1.5rem;
        padding: 12px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .book-card:hover {
        transform: scale(1.02);
        transition: transform 0.2s;
      }
      .book-cover {
        width: 130px;
        height: 190px;
        object-fit: cover;
        border-radius: 6px;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
      }
      .book-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .review-box {
        background-color: #f9f9f9;
        border-left: 4px solid #0d6efd;
        padding: 6px 10px;
        margin-top: 8px;
        border-radius: 4px;
        font-style: italic;
        color: #555;
        font-size: 0.85rem;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.05);
      }
      body {
        padding-bottom: 70px;
      }
      .book-actions {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #fff;
        border-top: 1px solid #ccc;
        padding: 10px 0;
        text-align: center;
        box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
        z-index: 1030;
      }
    </style>
  </head>
  <body class="bg-light">
    <% if (messages.success && messages.success.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= messages.success[0] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <% } %> <% if (messages.error && messages.error.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <%= messages.error[0] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <% } %>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold text-primary" href="/">Book Notes</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/explore">Explore</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/about">About</a>
            </li>
            <% if (isAuthenticated) { %>
            <li class="nav-item">
              <a class="nav-link" href="/users/<%= currentUser.id %>"
                ><i class="fa fa-user-circle"></i> My Page</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link text-danger" href="/logout">Logout</a>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/signup">Sign Up</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/login">Login</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

    <!-- User Info -->
    <div class="container mt-4">
      <div class="text-center mb-4">
        <% if (isOwner) { %>
        <p class="quote-text">Welcome, <%= user.name %></p>
        <h2>Books that Define You.</h2>
        <% } else { %>
        <h2><%= user.name %>'s Library</h2>
        <p class="quote-text">
          "A room without books is like a body without a soul."
        </p>
        <% } %>
      </div>

      <!-- Interests -->
      <div class="mb-4 text-center">
  <% if (user && user.id === currentUser.id) { %>
    <!-- Always show the interests -->
    <p><strong>Interests:</strong> 
      <%= user.interests && user.interests.length ? user.interests.join(", ") : "No interests added yet" %>
    </p>
  <% } %>
</div>


      <!-- Book List -->
      <div class="d-flex flex-wrap gap-4 justify-content-center">
        <% if (user.books && user.books.length > 0) { %> <%
        user.books.forEach(book => { %>
        <div class="book-card d-flex gap-3 align-items-start">
          <img
            src="https://books.google.com/books/content?id=<%= book.google_id %>&printsec=frontcover&img=1&zoom=1"
            class="book-cover"
            alt="Cover for <%= book.title %>"
          />
          <div class="book-info">
            <strong><%= book.title %></strong><br />
            <% if (book.rating != null) { %>
            <small class="text-muted">Rating: <%= book.rating %>/10</small
            ><br />
            <% } %> <% if (book.review_comment) { %>
            <div class="review-box mt-2">"<%= book.review_comment %>"</div>
            <% } %> <% if (isOwner) { %>
            <div class="mt-2 d-flex gap-2 flex-wrap">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#editBookModal-<%= book.id %>"
              >
                Edit
              </button>
              <form
                action="/books/<%= book.id %>/delete"
                method="POST"
                onsubmit="return confirm('Delete this book?');"
              >
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  Delete
                </button>
              </form>
            </div>
            <% } %>
          </div>
        </div>

        <% if (isOwner) { %>
        <!-- Edit Book Modal -->
        <div
          class="modal fade"
          id="editBookModal-<%= book.id %>"
          tabindex="-1"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <form
              class="modal-content"
              action="/books/<%= book.id %>/edit"
              method="POST"
            >
              <div class="modal-header">
                <h5 class="modal-title">Edit: <%= book.title %></h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Rating (0–10)</label>
                  <input
                    type="number"
                    class="form-control"
                    name="rating"
                    min="0"
                    max="10"
                    value="<%= book.rating ?? '' %>"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Review (Max 100 words)</label>
                  <textarea
                    class="form-control edit-review-input"
                    name="review_comment"
                    rows="3"
                    data-wordlimit="100"
                  >
<%= book.review_comment || '' %></textarea
                  >
                  <small class="text-muted edit-word-count">0/100 words</small>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
        <% } %> <% }) %> <% } else { %>
        <p class="text-center text-muted">No books added yet.</p>
        <% } %>
      </div>
    </div>

    <% if (isOwner) { %>
    <!-- Sticky Actions -->
    <div class="book-actions">
      <div class="container d-flex justify-content-center gap-2">
        <button
          class="btn btn-success btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#addBookModal"
        >
          Add Book
        </button>
        <button
          type="button"
          class="btn btn-outline-primary"
          data-bs-toggle="modal"
          data-bs-target="#editInterestsModal"
        >
          Edit Interests
        </button>
      </div>
    </div>

    <!-- Add Book Modal -->
    <div class="modal fade" id="addBookModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add a Book</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Google Books Search -->
            <div class="mb-3">
              <label for="searchQuery" class="form-label"
                >Search for a book (title or author)</label
              >
              <div class="input-group">
                <input
                  type="text"
                  id="searchQuery"
                  class="form-control"
                  placeholder="e.g., Harry Potter"
                />
                <button
                  type="button"
                  class="btn btn-primary"
                  id="searchBooksBtn"
                >
                  Search
                </button>
              </div>
            </div>
            <div id="bookResults" class="mt-3"></div>

            <!-- Selected Book Review Form -->
            <form
              id="addBookForm"
              action="/books/add"
              method="POST"
              style="display: none"
            >
              <input type="hidden" name="title" id="selectedBookTitle" />
              <input type="hidden" name="google_id" id="selectedBookGoogleId" />
              <div class="mb-3">
                <label class="form-label">Rating (0–10)</label>
                <input
                  type="number"
                  name="rating"
                  id="ratingInput"
                  class="form-control"
                  min="0"
                  max="10"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Review (Max 100 words)</label>
                <textarea
                  name="review_comment"
                  id="reviewInput"
                  class="form-control"
                  rows="3"
                  data-wordlimit="100"
                ></textarea>
                <small id="wordCount" class="text-muted">0/100 words</small>
              </div>
              <button type="submit" class="btn btn-success">Add Book</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <% if (isOwner) { %>
    <script>
      // Word count helper
      function enforceWordLimit(textarea, counterEl) {
        const maxWords = Number(textarea.dataset.wordlimit) || 100;
        let words = textarea.value.trim().split(/\s+/).filter(Boolean);
        if (words.length > maxWords) {
          textarea.value = words.slice(0, maxWords).join(" ");
          words = textarea.value.trim().split(/\s+/).filter(Boolean);
          alert("Review cannot exceed " + maxWords + " words.");
        }
        if (counterEl) counterEl.textContent = words.length + "/" + maxWords + " words";
      }

      // Add Book modal word counter
      const reviewInput = document.getElementById("reviewInput");
      const wordCount = document.getElementById("wordCount");
      if (reviewInput) reviewInput.addEventListener("input", () => enforceWordLimit(reviewInput, wordCount));

      // Edit modals word counters
      document.querySelectorAll(".edit-review-input").forEach((ta) => {
        const counter = ta.parentElement.querySelector(".edit-word-count");
        enforceWordLimit(ta, counter);
        ta.addEventListener("input", () => enforceWordLimit(ta, counter));
      });

      // Escape attr helper
      function escAttr(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/"/g, "&quot;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      // Google Books Search
      const searchBtn = document.getElementById("searchBooksBtn");
      const searchInput = document.getElementById("searchQuery");
      const searchResults = document.getElementById("bookResults");
      const addBookForm = document.getElementById("addBookForm");
      const selTitle = document.getElementById("selectedBookTitle");
      const selGoogleId = document.getElementById("selectedBookGoogleId");

      searchBtn?.addEventListener("click", async () => {
        const query = searchInput.value.trim();
        if (!query) {
          alert("Please enter a search term.");
          return;
        }
        searchResults.innerHTML = "<p>Searching...</p>";
        addBookForm.style.display = "none";
        try {
          const res = await fetch("https://www.googleapis.com/books/v1/volumes?q=" + encodeURIComponent(query));
          const data = await res.json();
          const items = data.items || [];
          if (!items.length) {
            searchResults.innerHTML = "<p>No results found.</p>";
            return;
          }
          const cards = items.map((b) => {
  const info = b.volumeInfo || {};
  const title = escAttr(info.title || "Untitled");
  const authors = escAttr((info.authors || []).join(", ") || "Unknown Author");
  const gid = escAttr(b.id || "");
  const cover = `https://books.google.com/books/content?id=${gid}&printsec=frontcover&img=1&zoom=1`;
  return `
    <div class="card mb-2 p-2">
      <div class="d-flex align-items-center">
        <img src="${cover}" alt="${title}" style="width:40px;height:auto;margin-right:8px;">
        <div class="flex-grow-1">
          <strong>${title}</strong><br>
          <small>${authors}</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary ms-2" data-gid="${gid}" data-title="${title}">
          Select
        </button>
      </div>
    </div>
  `;
}).join("");

          searchResults.innerHTML = cards;
          // Add click handlers to Select buttons
          searchResults.querySelectorAll("button[data-gid]").forEach((btn) => {
            btn.addEventListener("click", () => {
              selTitle.value = btn.dataset.title;
              selGoogleId.value = btn.dataset.gid;
              addBookForm.style.display = "block";
              addBookForm.scrollIntoView({ behavior: "smooth", block: "start" });
            });
          });
        } catch (err) {
          console.error(err);
          searchResults.innerHTML = "<p>Error fetching results.</p>";
        }
      });
    </script>
    <% } %> <% } %>

    <!-- Edit Interests Modal -->
    <div
      class="modal fade"
      id="editInterestsModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <form
          class="modal-content"
          action="/users/<%= user.id %>/interests"
          method="POST"
        >
          <div class="modal-header">
            <h5 class="modal-title">Edit Your Interests</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Your Interests</label>
              <textarea
                class="form-control"
                name="interests"
                rows="4"
                placeholder="e.g., fiction, AI, productivity, classics"
              >
<%= user.interests ? user.interests.join(', ') : '' %></textarea
              >
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary btn-sm">
              Save Interests
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

  </body>
</html>
